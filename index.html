<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>BCV Rates via Jina AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Tu estilo se mantiene igual */
    * { box-sizing: border-box; }
    body { margin: 0; background: black; color: white; font-family: Arial, sans-serif; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .app { width: 100%; max-width: 360px; text-align: center; }
    .rate { font-size: clamp(20px, 6vw, 26px); margin: 12px 0; }
    button { margin-top: 15px; padding: 12px; width: 100%; font-size: 16px; cursor: pointer; border: none; background: white; color: black; font-weight: bold; }
    button:active { opacity: 0.8; }
    .update { margin-top: 10px; font-size: 12px; color: #aaa; }
    .log { margin-top: 15px; background: #111; border: 1px solid #333; padding: 10px; font-size: 12px; height: 140px; overflow-y: auto; text-align: left; color: #0f0; }
  </style>
</head>
<body>

<div class="app">
  <div class="rate">USD: <span id="usd">-</span> Bs</div>
  <div class="rate">EUR: <span id="eur">-</span> Bs</div>

  <button onclick="fetchRates()">Actualizar con Jina AI</button>

  <div class="update" id="update"></div>
  <div class="log" id="log"></div>
</div>

<script>
  const logBox = document.getElementById("log");
  const usdEl = document.getElementById("usd");
  const eurEl = document.getElementById("eur");
  const updateEl = document.getElementById("update");

  function log(msg) {
    const time = new Date().toLocaleTimeString();
    logBox.innerHTML = `[${time}] ${msg}<br>` + logBox.innerHTML;
  }

  function saveData(usd, eur, date) {
    localStorage.setItem("usd", usd);
    localStorage.setItem("eur", eur);
    localStorage.setItem("updatedAt", date);
  }

  function loadData() {
    const usd = localStorage.getItem("usd");
    const eur = localStorage.getItem("eur");
    const date = localStorage.getItem("updatedAt");
    if (usd && eur && date) {
      usdEl.textContent = usd;
      eurEl.textContent = eur;
      updateEl.textContent = "Última actualización: " + date;
      log("Datos cargados de caché");
    }
  }

  async function fetchRates() {
    log("Conectando a r.jina.ai...");
    
    try {
      // Usamos el proxy de Jina directamente
      const url = "https://r.jina.ai/https://www.bcv.org.ve/";
      
      const res = await fetch(url);
      if (!res.ok) throw new Error("Error en respuesta de red");
      
      const text = await res.text();

      // Buscamos los valores usando Regex basándonos en la estructura de Jina
      // Jina suele renderizar: "Euro ... valor" y "Dólar ... valor"
      const usdMatch = text.match(/Dólar de la BCV\s*([\d,.]+)/i) || text.match(/USD\s*([\d,.]+)/i);
      const eurMatch = text.match(/Euro\s*([\d,.]+)/i) || text.match(/EUR\s*([\d,.]+)/i);

      let usd = usdMatch ? usdMatch[1].trim() : null;
      let eur = eurMatch ? eurMatch[1].trim() : null;

      // Si falla el regex específico, intentamos uno más genérico por posición
      if (!usd) {
          log("Reintentando extracción genérica...");
          // El BCV suele poner los valores después de las etiquetas de moneda
          const values = text.match(/\d+,\d+/g); 
          if(values && values.length >= 5) {
              eur = values[0];
              usd = values[4]; // El dólar suele ser el último de la lista principal
          }
      }

      if (!usd || !eur) {
        log("Error: Formato de datos no reconocido");
        return;
      }

      const date = new Date().toLocaleString();
      usdEl.textContent = usd;
      eurEl.textContent = eur;
      updateEl.textContent = "Actualizado: " + date;

      saveData(usd, eur, date);
      log(`¡Éxito! USD: ${usd}`);

    } catch (e) {
      log("Error: " + e.message);
      console.error(e);
    }
  }

  loadData();
</script>

</body>
</html>
